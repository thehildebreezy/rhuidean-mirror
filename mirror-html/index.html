<html>
    <head>
        <title>Stone of Tear Mirror Display</title>
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
        <link type="text/css" rel="stylesheet" href="style.css" />
        <link type="text/css" rel="stylesheet" href="weather-icons-master/css/weather-icons.css" />
        <script>
            /**
 * Setup holder to hold our logic
 * Should be electron independent so we won't have to worry too
 * much in our webview port about this changing on us
 */

const Update = {
    display : ( arg ) => {
        console.log('updating display')

        console.log(arg)

        jsonObj = JSON.parse( arg )
        if( jsonObj == null ){
            console.log('Bad JSON object')
            return
        }

        if( document.readyState !== "complete" ){
            console.log("DOM not ready")
            return
        }

        // update display
        // first get type
        var type = jsonObj['type'];
        if( type == null ){
            console.log('Bad message input')
        } else if( type == "other" ){
            Update.other( jsonObj['message'] )
        } else if( type == "time" ){
            Update.time( jsonObj['message'] )
        } else if( type == "weather" ){
            Update.weather( jsonObj['message'] )
        } else if( type == "forecast" ){
            Update.forecast( jsonObj['message'] )
        }

        else console.log('No valid type to process')
    },

    time: ( message ) => {
            
        var utcSec = parseInt(message)
        var utcUSec = utcSec * 1000

        Store.date = new Date( utcUSec )

        clearInterval(Store.interval)
        Store.interval = setInterval(Update.ticker,1000)
    },

    weather: ( message ) => {

        // make sure I can get the object
        var el = document.getElementById('weather')
        if( el == null ){
            console.log( "Could not find element #weather" )
        }

        // write this html to the element
        var HTML = "";

        // get weather information

        HTML += "<div id='temp'>"
        HTML += '<span class="big"><i class="wi wi-owm-'+ message['weather'][0]['id'] +'"></i>'
        HTML += Utility.ktof( message['main']['temp'] ) + "&deg;F</span>";
        
        //HTML += ''
        HTML += "</div>"
        HTML += "<div id='loc'>"
        HTML += message['name'] + ' / ' + message['weather'][0]['description']
        HTML += "</div>"

        // finaly act is to update the display
        el.innerHTML = HTML;
    },

    forecast : ( message ) => {
        // make sure I can get the object
        var el = document.getElementById('forecast')
        if( el == null ){
            console.log( "Could not find element" )
        }

        var HTML = ""

        // get forecast information
        HTML += "<table id='forecast'>"

        
        
        for( var i=0; i< message['list'].length; i++ ){
            HTML += "<tr><td>"
            
            var d = new Date( message['list'][i]['dt_txt'] )
            HTML += Utility.days[d.getDay()]+":"

            HTML += "</td><td>"
            HTML += '<i class="wi wi-owm-'+ message['list'][i]['weather'][0]['id'] +'"></i>'
            HTML += "</td><td>"
            HTML += Utility.ktof( message['list'][i]['main']['temp'] ) + "&deg;F";
            HTML += "</td></tr>"
        }

        HTML += "</table>"

        // finally update element
        el.innerHTML = HTML;
    },

    ticker : () => {

        // make sure I can get the object
        var el = document.getElementById('time')
        if( el == null ){
            console.log( "Could not find element #time" )
        }

        if( Store.date == null ) return;

        Store.date.setSeconds( Store.date.getSeconds() + 1)
        
        var h = Store.date.getHours()
        var m = Store.date.getMinutes()
        var seconds = Store.date.getSeconds()

        var year = Store.date.getFullYear()
        var month = Store.date.getMonth()
        var daynum = Store.date.getDate()

        var day = Store.date.getDay()

        var ampm = "pm"

        if ( m < 10 ){
            m = "0" + m
        }

        if( h == 0 ) {
            h = 12
            ampm = "am"
        } else if ( h < 12 ) {
            ampm = "am"
        } else if( h > 12 ) {
            h = h-12
            ampm = "pm"
        } else {
            ampm = "pm"
        }

        var color = (seconds%2 == 0) ? 'black' : 'white';

        var HTML = "";
        HTML += "<div class='big'>"
        HTML += h
        HTML += "<span id='sep' style='color:"+color+"'>:</span>"
        HTML += m + ampm
        HTML += "</div><div>"
        HTML += Utility.months[month] + " " + daynum + ", " + year
        HTML += "</div><div>"
        HTML += Utility.fullDays[day]
        HTML += "</div>"

        el.innerHTML = HTML
    }
}

var Store = {
    date : null,
    interval : null
}

const Utility = {
    ktof : ( Kelvin ) => {
        console.log(Kelvin)
        var K = parseInt(Kelvin)
        if( K == null ) {
            console.log("bad temperature input")
            return
        }
        return parseInt(Math.floor(32 + (((K-273.15) * 9)/5)))
    },

    
    days : ['S','M','T','W','T','F','S'],
    months : ["January","February","March","April","May","June","July","August","September","October","November","December"],
    fullDays : ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]
}



        </script>
        <script>
            
            function updateDisplay(){
                Update.display('{"type":"time","message":1595709800}')
                Update.display('{"type":"weather","message":{"coord":{"lon":-79.01,"lat":35.06},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"base":"stations","main":{"temp":306.06,"feels_like":309.15,"temp_min":305.93,"temp_max":306.15,"pressure":1018,"humidity":52},"visibility":10000,"wind":{"speed":2.1,"deg":200},"clouds":{"all":75},"dt":1595709916,"sys":{"type":1,"id":4062,"country":"US","sunrise":1595672423,"sunset":1595723067},"timezone":-14400,"id":0,"name":"Fayetteville","cod":200}}')
                Update.display('{"type":"forecast","message":{"cod":"200","message":0,"cnt":40,"list":[{"dt":1595764800,"main":{"temp":298.26,"feels_like":300.93,"temp_min":298.26,"temp_max":298.26,"pressure":1020,"sea_level":1020,"grnd_level":1012,"humidity":81,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":2.61,"deg":234},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2020-07-26 12:00:00"},{"dt":1595851200,"main":{"temp":298.55,"feels_like":300.39,"temp_min":298.55,"temp_max":298.55,"pressure":1017,"sea_level":1017,"grnd_level":1009,"humidity":80,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":5},"wind":{"speed":3.86,"deg":236},"visibility":10000,"pop":0.01,"sys":{"pod":"d"},"dt_txt":"2020-07-27 12:00:00"},{"dt":1595937600,"main":{"temp":299.33,"feels_like":301.11,"temp_min":299.33,"temp_max":299.33,"pressure":1014,"sea_level":1014,"grnd_level":1006,"humidity":77,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":18},"wind":{"speed":4.04,"deg":233},"visibility":10000,"pop":0.04,"sys":{"pod":"d"},"dt_txt":"2020-07-28 12:00:00"},{"dt":1596024000,"main":{"temp":298.63,"feels_like":302.29,"temp_min":298.63,"temp_max":298.63,"pressure":1014,"sea_level":1014,"grnd_level":1006,"humidity":84,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":93},"wind":{"speed":1.93,"deg":253},"visibility":10000,"pop":0.34,"rain":{"3h":0.76},"sys":{"pod":"d"},"dt_txt":"2020-07-29 12:00:00"},{"dt":1596110400,"main":{"temp":297.68,"feels_like":300.19,"temp_min":297.68,"temp_max":297.68,"pressure":1013,"sea_level":1013,"grnd_level":1005,"humidity":85,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":56},"wind":{"speed":3.01,"deg":218},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2020-07-30 12:00:00"}],"city":{"name":"Fayetteville","coord":{"lat":35.0583,"lon":-79.008},"country":"US","timezone":-14400,"sunrise":1595672423,"sunset":1595723066}}}')
            }
        </script>
        
    </head>
    <body onload="updateDisplay()">
        <div class="upper left">
            <div id="time">
                8:42am
            </div>
        </div>
        <div class="upper right">
            <div id="weather">
                74&deg;F
                
            </div>
            <div id="forecast">
                Forecast
            </div>
        </div>
        <div class="lower left"></div>
        <div class="lower right"></div>

    </body>
</html>